name: LaTeX Quality Check

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - '**.tex'
      - '**.bib'
      - '.github/workflows/latex-quality-check.yml'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chktex hunspell hunspell-en-us hunspell-ru aspell aspell-en aspell-ru

      - name: LaTeX Linting with ChkTeX
        id: chktex
        continue-on-error: true
        run: |
          echo "## ChkTeX Results" > chktex_report.md
          echo "" >> chktex_report.md

          ERRORS_FOUND=0
          for file in $(find ./chapters -name "*.tex" 2>/dev/null | sort); do
            echo "Checking $file..."
            if ! chktex -q -v0 "$file" > /tmp/chktex_output.txt 2>&1; then
              if [ -s /tmp/chktex_output.txt ]; then
                echo "### üìÑ \`$file\`" >> chktex_report.md
                echo '```' >> chktex_report.md
                cat /tmp/chktex_output.txt >> chktex_report.md
                echo '```' >> chktex_report.md
                echo "" >> chktex_report.md
                ERRORS_FOUND=1
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 0 ]; then
            echo "‚úÖ No LaTeX linting issues found in ./chapters!" >> chktex_report.md
          fi

          cat chktex_report.md

      - name: Spell Check (Combined)
        id: spellcheck
        continue-on-error: true
        run: |
          echo "## Spell Check Results" > spellcheck_report.md
          echo "" >> spellcheck_report.md

          # Prepare custom dictionaries
          if [ -f ".github/custom_dict.txt" ]; then
            cp .github/custom_dict.txt custom_dict_ru.txt
          else
            printf "LaTeX\nPDF\nGitHub\nActions\nworkflow\n" > custom_dict_ru.txt
          fi

          if [ -f ".github/custom_dict_en.txt" ]; then
            cp .github/custom_dict_en.txt custom_dict_en.txt
          else
            printf "LaTeX\nPDF\nGitHub\nworkflow\n" > custom_dict_en.txt
          fi

          ERRORS_FOUND=0
          for file in $(find ./chapters -name "*.tex" 2>/dev/null | sort); do
            echo "Checking spelling in $file..."

            # Extract text from LaTeX
            sed 's/\\[a-zA-Z]*{//g; s/}//g; s/\\[a-zA-Z]*//g' "$file" > /tmp/clean_text.txt

            # Check with both Russian and English dictionaries
            hunspell -d ru_RU -l -p custom_dict_ru.txt /tmp/clean_text.txt 2>/dev/null | sort | uniq > /tmp/not_russian.txt
            hunspell -d en_US -l -p custom_dict_en.txt /tmp/clean_text.txt 2>/dev/null | sort | uniq > /tmp/not_english.txt

            # Find words that fail BOTH dictionaries (likely actual errors)
            comm -12 /tmp/not_russian.txt /tmp/not_english.txt > /tmp/actual_errors.txt

            if [ -s /tmp/actual_errors.txt ]; then
              UNIQUE_ERRORS=$(head -20 /tmp/actual_errors.txt)
              if [ ! -z "$UNIQUE_ERRORS" ]; then
                echo "### üìÑ \`$file\`" >> spellcheck_report.md
                echo "" >> spellcheck_report.md
                echo "–°–ª–æ–≤–∞, –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–∏ –≤ —Ä—É—Å—Å–∫–æ–º, –Ω–∏ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ:" >> spellcheck_report.md
                echo '```' >> spellcheck_report.md
                echo "$UNIQUE_ERRORS" >> spellcheck_report.md
                echo '```' >> spellcheck_report.md
                echo "" >> spellcheck_report.md
                ERRORS_FOUND=1
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 0 ]; then
            echo "‚úÖ No spelling issues found!" >> spellcheck_report.md
          else
            echo "> ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–æ–≤–∞ –≤—ã—à–µ. –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –æ–ø–µ—á–∞—Ç–∫–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã." >> spellcheck_report.md
            echo "> –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –≤ \`.github/custom_dict.txt\` (—Ä—É—Å—Å–∫–∏–µ) –∏–ª–∏ \`.github/custom_dict_en.txt\` (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)" >> spellcheck_report.md
          fi

          cat spellcheck_report.md

      - name: Post ChkTeX Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let chktexReport = '';

            if (fs.existsSync('chktex_report.md')) {
              chktexReport = fs.readFileSync('chktex_report.md', 'utf8');
            } else {
              chktexReport = '## ChkTeX Results\n\n‚úÖ No LaTeX linting issues found!';
            }

            const parts = [
              '# üîç LaTeX Code Quality Check',
              '',
              chktexReport,
              '',
              '---',
              '',
              'üí° **Tip:** ChkTeX warnings are suggestions, not errors - use your judgment. You can configure rules in `.chktexrc` if needed.'
            ];
            const commentBody = parts.join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üîç LaTeX Code Quality Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Post Spell Check Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let spellcheckReport = '';

            if (fs.existsSync('spellcheck_report.md')) {
              spellcheckReport = fs.readFileSync('spellcheck_report.md', 'utf8');
            } else {
              spellcheckReport = '## Spell Check Results\n\n‚úÖ No spelling issues found!';
            }

            const parts = [
              '# üìù Spell Check Report (RU + EN)',
              '',
              spellcheckReport,
              '',
              '---',
              '',
              'üí° **How it works:**',
              '',
              'This check compares words against both Russian and English dictionaries. Only words that fail BOTH dictionaries are reported as potential errors. This eliminates false positives from mixed-language documents.',
              '',
              '**Tips:**',
              '- Add technical terms to `.github/custom_dict.txt` (Russian) or `.github/custom_dict_en.txt` (English)',
              '- Some LaTeX commands may still trigger false positives',
              '- Review the suggestions carefully'
            ];
            const commentBody = parts.join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üìù Spell Check Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
