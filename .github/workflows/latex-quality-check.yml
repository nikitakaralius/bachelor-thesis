name: LaTeX Quality Check

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - '**.tex'
      - '**.bib'
      - '.github/workflows/latex-quality-check.yml'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chktex hunspell hunspell-en-us hunspell-ru aspell aspell-en aspell-ru

      - name: LaTeX Linting with ChkTeX
        id: chktex
        continue-on-error: true
        run: |
          echo "## ChkTeX Results" > chktex_report.md
          echo "" >> chktex_report.md

          ERRORS_FOUND=0
          for file in $(find . -name "*.tex" -not -path "./template_settings/*"); do
            echo "Checking $file..."
            if ! chktex -q -v0 "$file" > /tmp/chktex_output.txt 2>&1; then
              if [ -s /tmp/chktex_output.txt ]; then
                echo "### ðŸ“„ \`$file\`" >> chktex_report.md
                echo '```' >> chktex_report.md
                cat /tmp/chktex_output.txt >> chktex_report.md
                echo '```' >> chktex_report.md
                echo "" >> chktex_report.md
                ERRORS_FOUND=1
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 0 ]; then
            echo "âœ… No LaTeX linting issues found!" >> chktex_report.md
          fi

          cat chktex_report.md

      - name: Spell Check (Russian)
        id: spellcheck-ru
        continue-on-error: true
        run: |
          echo "## Spell Check Results (Russian)" > spellcheck_ru_report.md
          echo "" >> spellcheck_ru_report.md

          # Use custom dictionary if exists, otherwise create default
          if [ -f ".github/custom_dict.txt" ]; then
            cp .github/custom_dict.txt custom_dict.txt
          else
            printf "LaTeX\nPDF\nGitHub\nActions\nworkflow\n" > custom_dict.txt
          fi

          ERRORS_FOUND=0
          for file in $(find ./chapters -name "*.tex" 2>/dev/null); do
            echo "Checking Russian spelling in $file..."

            # Extract text from LaTeX (remove commands, but keep text)
            sed 's/\\[a-zA-Z]*{//g; s/}//g; s/\\[a-zA-Z]*//g' "$file" > /tmp/clean_text.txt

            # Run hunspell
            if hunspell -d ru_RU -l -p custom_dict.txt /tmp/clean_text.txt > /tmp/misspelled.txt 2>/dev/null; then
              if [ -s /tmp/misspelled.txt ]; then
                UNIQUE_ERRORS=$(sort /tmp/misspelled.txt | uniq | head -20)
                if [ ! -z "$UNIQUE_ERRORS" ]; then
                  echo "### ðŸ“„ \`$file\`" >> spellcheck_ru_report.md
                  echo "" >> spellcheck_ru_report.md
                  echo "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¾Ñ€Ñ„Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:" >> spellcheck_ru_report.md
                  echo '```' >> spellcheck_ru_report.md
                  echo "$UNIQUE_ERRORS" >> spellcheck_ru_report.md
                  echo '```' >> spellcheck_ru_report.md
                  echo "" >> spellcheck_ru_report.md
                  ERRORS_FOUND=1
                fi
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 0 ]; then
            echo "âœ… No Russian spelling issues found!" >> spellcheck_ru_report.md
          else
            echo "> âš ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐ»Ð¾Ð²Ð° Ð²Ñ‹ÑˆÐµ. ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð¼Ð¸ - Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ñ… Ð² custom_dict.txt" >> spellcheck_ru_report.md
          fi

          cat spellcheck_ru_report.md

      - name: Spell Check (English)
        id: spellcheck-en
        continue-on-error: true
        run: |
          echo "## Spell Check Results (English)" > spellcheck_en_report.md
          echo "" >> spellcheck_en_report.md

          # Use custom dictionary if exists, otherwise create default
          if [ -f ".github/custom_dict_en.txt" ]; then
            cp .github/custom_dict_en.txt custom_dict_en.txt
          else
            printf "LaTeX\nPDF\nGitHub\nworkflow\n" > custom_dict_en.txt
          fi

          ERRORS_FOUND=0
          for file in $(find ./chapters -name "*.tex" 2>/dev/null); do
            echo "Checking English spelling in $file..."

            # Extract text from LaTeX
            sed 's/\\[a-zA-Z]*{//g; s/}//g; s/\\[a-zA-Z]*//g' "$file" > /tmp/clean_text_en.txt

            # Run hunspell for English
            if hunspell -d en_US -l -p custom_dict_en.txt /tmp/clean_text_en.txt > /tmp/misspelled_en.txt 2>/dev/null; then
              if [ -s /tmp/misspelled_en.txt ]; then
                UNIQUE_ERRORS=$(sort /tmp/misspelled_en.txt | uniq | head -20)
                if [ ! -z "$UNIQUE_ERRORS" ]; then
                  echo "### ðŸ“„ \`$file\`" >> spellcheck_en_report.md
                  echo "" >> spellcheck_en_report.md
                  echo "Possible spelling errors:" >> spellcheck_en_report.md
                  echo '```' >> spellcheck_en_report.md
                  echo "$UNIQUE_ERRORS" >> spellcheck_en_report.md
                  echo '```' >> spellcheck_en_report.md
                  echo "" >> spellcheck_en_report.md
                  ERRORS_FOUND=1
                fi
              fi
            fi
          done

          if [ $ERRORS_FOUND -eq 0 ]; then
            echo "âœ… No English spelling issues found!" >> spellcheck_en_report.md
          else
            echo "> âš ï¸ Check words above. Some may be technical terms - add them to custom_dict_en.txt" >> spellcheck_en_report.md
          fi

          cat spellcheck_en_report.md

      - name: Combine Reports
        if: always()
        run: |
          cat > combined_report.md <<'REPORT_START'
          # ðŸ“‹ LaTeX Quality Check Report

          This automated check helps maintain code quality and catch potential issues early.

          ---

          REPORT_START

          if [ -f chktex_report.md ]; then
            cat chktex_report.md >> combined_report.md
            echo "" >> combined_report.md
            echo "---" >> combined_report.md
            echo "" >> combined_report.md
          fi

          if [ -f spellcheck_ru_report.md ]; then
            cat spellcheck_ru_report.md >> combined_report.md
            echo "" >> combined_report.md
            echo "---" >> combined_report.md
            echo "" >> combined_report.md
          fi

          if [ -f spellcheck_en_report.md ]; then
            cat spellcheck_en_report.md >> combined_report.md
            echo "" >> combined_report.md
          fi

          cat >> combined_report.md <<'REPORT_END'

          ---

          ðŸ’¡ **Tips:**
          - Add technical terms to `.github/custom_dict.txt` (Russian) or `.github/custom_dict_en.txt` (English)
          - Some LaTeX commands may trigger false positives in spell checking
          - ChkTeX warnings are suggestions, not errors - use your judgment

          REPORT_END

          cat combined_report.md

      - name: Post PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('combined_report.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“‹ LaTeX Quality Check Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
